#!/bin/sh

# Check if we can run npm commands (node_modules exists)
HAS_NODE_MODULES=false
if [ -d "node_modules/.bin" ]; then
  HAS_NODE_MODULES=true
fi

# Determine what changed
STAGED=$(git diff --cached --name-only)

# Check if only content files changed
CONTENT_ONLY=true
for file in $STAGED; do
  case "$file" in
    src/content/*.md|src/content/**/*.md|src/content/*.mdx|src/content/**/*.mdx) ;;
    *) CONTENT_ONLY=false; break ;;
  esac
done

if [ "$CONTENT_ONLY" = true ] && [ -n "$STAGED" ]; then
  echo "üìù Content-only changes detected - running schema validation"
  if [ "$HAS_NODE_MODULES" = true ]; then
    npx astro check
  else
    echo "‚ö†Ô∏è  No node_modules found - skipping validation (run 'make ci' before pushing)"
  fi
else
  echo "üîß Code changes detected - running full pre-commit"
  if [ "$HAS_NODE_MODULES" = true ]; then
    npx lint-staged
    npx astro check
  else
    echo "‚ö†Ô∏è  No node_modules found - skipping validation (run 'make ci' before pushing)"
  fi
fi
